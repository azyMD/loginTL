<!-- public/game.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TicTacToe Game</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>TicTacToe - Match</h1>
    <div id="status"></div>
    <div id="board"></div>

    <div style="margin-top:15px;">
      <button id="replay-btn">Replay</button>
      <button id="quit-btn" style="margin-left:10px;">Quit</button>
    </div>
  </div>

  <!-- Socket.io client -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    console.log("Game page JS loaded!");

    // 1. Connect to Socket.io
    const socket = io();
    console.log("Socket connected:", socket);

    // 2. Grab DOM elements
    const boardEl   = document.getElementById('board');
    const statusEl  = document.getElementById('status');
    const replayBtn = document.getElementById('replay-btn');
    const quitBtn   = document.getElementById('quit-btn');

    // 3. Parse query params
    const params     = new URLSearchParams(window.location.search);
    const gameId     = params.get('gameId');
    const userId     = params.get('userId');
    const opponentId = params.get('opponentId');

    console.log("GameID:", gameId, "UserID:", userId, "OpponentID:", opponentId);

    // 4. Build the 3x3 board
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement('div');
      cell.dataset.index = i;
      cell.addEventListener('click', () => {
        console.log("Cell clicked:", i);
        makeMove(i);
      });
      boardEl.appendChild(cell);
    }

    // 5. Make a move => emit to server
    function makeMove(cellIndex) {
      console.log("Emitting makeMove event with:", { gameId, userId, cellIndex });
      socket.emit('makeMove', { gameId, userId, cellIndex });
    }

    // 6. Listen for server updates
    socket.on('updateGame', (payload) => {
      console.log("Received updateGame from server:", payload);
      const { board, currentTurn, winner } = payload;
      renderBoard(board);
      renderStatus(currentTurn, winner);
    });

    socket.on('gameEnded', ({ winner }) => {
      console.log("Received gameEnded event. Winner:", winner);
      if (winner === 'tie') {
        alert("Itâ€™s a tie!");
      } else if (String(winner) === String(userId)) {
        alert("You won!");
      } else {
        alert("Opponent won!");
      }
      // Return to lobby
      window.location.href = `/lobby.html?userId=${userId}`;
    });

    // 7. Replay / Quit
    replayBtn.addEventListener('click', () => {
      console.log("Replay button clicked, re-challenging same opponent...");
      socket.emit('challengePlayer', {
        challengerId: userId,
        challengedId: opponentId
      });
    });

    quitBtn.addEventListener('click', () => {
      console.log("Quit button clicked, emitting quitGame...");
      socket.emit('quitGame', { gameId, userId });
    });

    // 8. If new game is started by replay
    socket.on('gameStarted', ({ gameId: newGameId, opponentId: newOpp }) => {
      console.log("Received gameStarted for new match:", newGameId, newOpp);
      // redirect to new game
      window.location.href = `/game.html?gameId=${newGameId}&userId=${userId}&opponentId=${newOpp}`;
    });

    // ---- HELPER Functions ----
    function renderBoard(board) {
      const cells = boardEl.children;
      for (let i = 0; i < 9; i++) {
        cells[i].textContent = board[i] || '';
      }
    }

    function renderStatus(currentTurn, winner) {
      if (winner === 'tie') {
        statusEl.textContent = "It's a tie!";
      } else if (winner) {
        if (String(winner) === String(userId)) {
          statusEl.textContent = "You Won!";
        } else {
          statusEl.textContent = "Opponent Won!";
        }
      } else {
        // No winner => whose turn?
        if (String(currentTurn) === String(userId)) {
          statusEl.textContent = "Your turn...";
        } else {
          statusEl.textContent = "Opponent's turn...";
        }
      }
    }
  </script>
</body>
</html>
