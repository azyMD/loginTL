<!-- public/lobby.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TicTacToe Lobby</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>TicTacToe Lobby</h1>

    <table id="players-table" style="width:100%; border-collapse:collapse; margin-top:20px;">
      <thead>
        <tr>
          <th style="padding:8px; text-align:left;">Player</th>
          <th style="padding:8px; text-align:left;">Games / Won / Lost</th>
          <th style="padding:8px; text-align:left;">Action</th>
        </tr>
      </thead>
      <tbody id="players-body"></tbody>
    </table>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket      = io();
    const playersBody = document.getElementById('players-body');

    // Grab userId from query
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('userId');

    // Join lobby
    socket.emit('joinLobby', { userId });

    // Listen for player updates
    socket.on('onlinePlayers', (players) => {
      playersBody.innerHTML = '';
      players.forEach(p => {
        let row = document.createElement('tr');

        // Fallback stats
        let gamesCount = p.gamesCount || 0;
        let gamesWon   = p.gamesWon   || 0;
        let gamesLost  = p.gamesLost  || 0;

        // 1) Name cell
        let tdName = document.createElement('td');
        tdName.style.padding = '8px';
        tdName.textContent = p.displayName || "UnknownUser";
        row.appendChild(tdName);

        // 2) Stats cell
        let tdStats = document.createElement('td');
        tdStats.style.padding = '8px';
        tdStats.textContent = `${gamesCount} / ${gamesWon} / ${gamesLost}`;
        row.appendChild(tdStats);

        // 3) Action cell
        let tdAction = document.createElement('td');
        tdAction.style.padding = '8px';

        if (String(p.userId) === String(userId)) {
          tdAction.textContent = "This is you";
        } else if (p.inGame) {
          tdAction.textContent = "In Game";
        } else {
          // Send Challenge button
          let btnChallenge = document.createElement('button');
          btnChallenge.textContent = "Send Challenge";
          btnChallenge.onclick = () => {
            socket.emit('sendChallenge', {
              challengerId: userId,
              challengedId: p.userId
            });
          };
          tdAction.appendChild(btnChallenge);
        }
        row.appendChild(tdAction);

        playersBody.appendChild(row);
      });
    });

    // If a game starts => go to the new game
    socket.on('gameStarted', ({ gameId, opponentId }) => {
      window.location.href = `/game.html?gameId=${gameId}&userId=${userId}&opponentId=${opponentId}`;
    });

    // If we get an error
    socket.on('errorMsg', (msg) => {
      alert(msg);
    });

    // =========== CHALLENGE FLOW ===========
    // We receive a challenge from another user
    socket.on('challengeReceived', ({ fromId, fromName }) => {
      let accept = confirm(`Player "${fromName}" is challenging you. Accept?`);
      if (accept) {
        socket.emit('acceptChallenge', { challengedId: userId });
      } else {
        socket.emit('refuseChallenge', { challengedId: userId });
      }
    });

    // If the challenger sees the challenge was refused
    socket.on('challengeRefused', ({ refusedBy }) => {
      alert(`Your challenge was refused by user ${refusedBy}.`);
    });
  </script>
</body>
</html>
