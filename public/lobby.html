<!-- public/lobby.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TicTacToe Lobby</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>TicTacToe Lobby</h1>

    <table id="players-table" style="width:100%; margin-top:20px; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="padding:8px; text-align:left;">Player</th>
          <th style="padding:8px; text-align:left;">Games / Won / Lost</th>
          <th style="padding:8px; text-align:left;">Action</th>
        </tr>
      </thead>
      <tbody id="players-body"></tbody>
    </table>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const playersBody = document.getElementById('players-body');

    const params = new URLSearchParams(window.location.search);
    const userId = params.get('userId');

    // Join the lobby
    socket.emit('joinLobby', { userId });

    // Show players
    socket.on('onlinePlayers', (players) => {
      playersBody.innerHTML = '';
      players.forEach(p => {
        const row = document.createElement('tr');

        const gamesCount = p.gamesCount || 0;
        const gamesWon   = p.gamesWon   || 0;
        const gamesLost  = p.gamesLost  || 0;

        // Player name
        const tdName = document.createElement('td');
        tdName.style.padding = '8px';
        tdName.textContent = p.displayName || "User??";
        row.appendChild(tdName);

        // Stats
        const tdStats = document.createElement('td');
        tdStats.style.padding = '8px';
        tdStats.textContent = `${gamesCount} / ${gamesWon} / ${gamesLost}`;
        row.appendChild(tdStats);

        // Action
        const tdAction = document.createElement('td');
        tdAction.style.padding = '8px';

        if (String(p.userId) === String(userId)) {
          tdAction.textContent = "This is you";
        } else if (p.inGame) {
          tdAction.textContent = "In Game";
        } else {
          // Send Challenge
          const btn = document.createElement('button');
          btn.textContent = "Send Challenge";
          btn.onclick = () => {
            socket.emit('sendChallenge', {
              challengerId: userId,
              challengedId: p.userId
            });
          };
          tdAction.appendChild(btn);
        }

        row.appendChild(tdAction);
        playersBody.appendChild(row);
      });
    });

    // Game started => move to game page
    socket.on('gameStarted', ({ gameId, opponentId }) => {
      window.location.href = `/game.html?gameId=${gameId}&userId=${userId}&opponentId=${opponentId}`;
    });

    // Any error
    socket.on('errorMsg', (msg) => {
      alert(msg);
    });

    // Challenge received => accept/refuse
    socket.on('challengeReceived', ({ fromId, fromName }) => {
      const accept = confirm(`Player "${fromName}" is challenging you. Accept?`);
      if (accept) {
        socket.emit('acceptChallenge', { challengedId: userId });
      } else {
        socket.emit('refuseChallenge', { challengedId: userId });
      }
    });

    // If your challenge was refused
    socket.on('challengeRefused', ({ refusedBy }) => {
      alert(`Your challenge was refused by user: ${refusedBy}`);
    });
  </script>
</body>
</html>
