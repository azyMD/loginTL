<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TicTacToe Login</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>TicTacToe Login</h1>

    <button id="btn-incog">Incognito</button>
    <div id="incog-form" style="display:none;">
      <input type="text" id="incog-username" placeholder="Your username" />
      <button id="incog-submit">Go</button>
    </div>

    <!-- Telegram Login Widget -->
    <script
      async
      src="https://telegram.org/js/telegram-widget.js?22"
      data-telegram-login="logintl_bot"
      data-size="large"
      data-onauth="onTelegramAuth(user)"
      data-request-access="write">
    </script>
  </div>

  <script>
    const incogBtn  = document.getElementById('btn-incog');
    const incogForm = document.getElementById('incog-form');
    const incogUser = document.getElementById('incog-username');
    const incogSub  = document.getElementById('incog-submit');

    incogBtn.addEventListener('click', () => {
      incogForm.style.display = 'block';
    });

    incogSub.addEventListener('click', async () => {
      const username = incogUser.value.trim();
      if (!username) {
        alert("Please enter a username");
        return;
      }
      try {
        const res = await fetch('/incognito', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ username })
        });
        if (!res.ok) {
          alert("Incognito error: " + (await res.text()));
          return;
        }
        const data = await res.json();
        window.location.href = `/lobby.html?userId=${data.userId}`;
      } catch (err) {
        alert("Incognito login request failed");
        console.error(err);
      }
    });

    // Called by Telegram widget upon success
    function onTelegramAuth(user) {
      fetch('/auth', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(user)
      })
      .then(async (res) => {
        if (!res.ok) {
          alert(await res.text());
          return;
        }
        // success => user.id => go lobby
        window.location.href = `/lobby.html?userId=${user.id}`;
      })
      .catch(err => {
        alert("Telegram login error");
        console.error(err);
      });
    }
    window.onTelegramAuth = onTelegramAuth;
  </script>
</body>
</html>
