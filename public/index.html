<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login to TicTacToe</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>TicTacToe Login</h1>

    <p>Choose a login method:</p>

    <!-- Incognito -->
    <button id="btn-incognito">Incognito</button>
    <div id="incognito-form" style="display:none;">
      <input type="text" id="incognito-username" placeholder="Enter username" />
      <button id="incognito-submit">GO</button>
    </div>

    <!-- Telegram Widget -->
    <script
      async
      src="https://telegram.org/js/telegram-widget.js?22"
      data-telegram-login="logintl_botE"  
      data-size="large"
      data-onauth="onTelegramAuth(user)"
      data-request-access="write">
    </script>
  </div>

  <script>
    const btnIncognito = document.getElementById('btn-incognito');
    const incogForm    = document.getElementById('incognito-form');
    const incogInput   = document.getElementById('incognito-username');
    const incogSubmit  = document.getElementById('incognito-submit');

    btnIncognito.addEventListener('click', () => {
      incogForm.style.display = 'block';
    });

    // incognito => /incognito => redirect to /lobby
    incogSubmit.addEventListener('click', async () => {
      const username = incogInput.value.trim();
      if (!username) {
        alert("Please enter a username");
        return;
      }
      try {
        const res = await fetch('/incognito', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        if (!res.ok) {
          alert(await res.text());
          return;
        }
        const data = await res.json();
        window.location.href = `/lobby.html?userId=${data.userId}`;
      } catch (err) {
        alert("Error logging in incognito");
        console.error(err);
      }
    });

    // Telegram => /auth => redirect to /lobby
    function onTelegramAuth(user) {
      fetch('/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(user)
      })
      .then(async (res) => {
        if (!res.ok) {
          alert(await res.text());
          return;
        }
        // success => redirect
        window.location.href = `/lobby.html?userId=${user.id}`;
      })
      .catch(err => {
        alert("Telegram login error");
        console.error(err);
      });
    }
    window.onTelegramAuth = onTelegramAuth;
  </script>
</body>
</html>
